generator client {
  provider   = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

model User {
  name           String
  email          String          @unique
  passwordHash   String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  id             Int             @id @default(autoincrement())
  ArcaConfig     ArcaConfig?
  ArcaInvoice    ArcaInvoice[]
  calendarEvents CalendarEvent[]
  assignedTasks  Task[]
  workLogs       WorkLog[]
  groups         Group[]         @relation("GroupToUser")
}

model Group {
  name        String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  id          Int               @id @default(autoincrement())
  permissions GroupPermission[]
  users       User[]            @relation("GroupToUser")
}

model Permission {
  name             String
  code             String            @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  id               Int               @id @default(autoincrement())
  groupPermissions GroupPermission[]
}

model GroupPermission {
  createdAt    DateTime   @default(now())
  id           Int        @id @default(autoincrement())
  groupId      Int
  permissionId Int
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([groupId, permissionId])
}

model Lead {
  name      String
  email     String?
  phone     String?
  company   String?
  status    LeadStatus @default(new)
  notes     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  id        Int        @id @default(autoincrement())
}

model Client {
  name            String
  email           String?   @unique
  phone           String?
  company         String?
  address         String?
  slug            String    @unique
  isPortalEnabled Boolean   @default(false)
  passwordHash    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  id              Int       @id @default(autoincrement())
  projects        Project[]
  tickets         Ticket[]

  @@map("cliente")
}

model Project {
  name           String
  description    String?
  status         ProjectStatus @default(active)
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  id             Int           @id @default(autoincrement())
  clientId       Int
  githubRepo     String?
  currency       String        @default("ARS")
  paidAmount     Decimal       @default(0) @db.Decimal(12, 2)
  paymentDueDate DateTime?
  totalAmount    Decimal?      @db.Decimal(12, 2)
  files          File[]
  payments       Payment[]
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  servers        Server[]
  tasks          Task[]
  arcaInvoices   ArcaInvoice[]
}

model Ticket {
  title       String
  description String?
  priority    TicketPriority @default(medium)
  status      TicketStatus   @default(open)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  id          Int            @id @default(autoincrement())
  clientId    Int
  tasks       Task[]
  client      Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Task {
  title              String
  description        String?
  status             TaskStatus   @default(pending)
  priority           TaskPriority @default(medium)
  startDate          DateTime?
  endDate            DateTime?
  timeEstimated      String?
  timeSpent          String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  includeInChangeLog Boolean      @default(false)
  id                 Int          @id @default(autoincrement())
  projectId          Int
  ticketId           Int?
  assignedToId       Int?
  category           String?
  code               String       @unique
  commits            Commit[]
  assignedTo         User?        @relation(fields: [assignedToId], references: [id])
  project            Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ticket             Ticket?      @relation(fields: [ticketId], references: [id])
  workLogs           WorkLog[]
}

model Commit {
  message     String
  author      String
  hash        String   @unique
  repository  String
  createdAt   DateTime @default(now())
  id          Int      @id @default(autoincrement())
  taskId      Int
  url         String?
  committedAt DateTime
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model Payment {
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("ARS")
  concept       String?
  paymentMethod String?
  status        PaymentStatus @default(pending)
  fechaPago     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  id            Int           @id @default(autoincrement())
  projectId     Int
  invoices      Invoice[]
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  arcaInvoices  ArcaInvoice[]
}

model Invoice {
  invoiceNumber String        @unique
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("ARS")
  emitted       DateTime      @default(now())
  expiresAt     DateTime?
  status        InvoiceStatus @default(unpaid)
  link          String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  id            Int           @id @default(autoincrement())
  paymentId     Int
  payment       Payment       @relation(fields: [paymentId], references: [id], onDelete: Cascade)
}

model File {
  name        String
  url         String
  type        String?
  size        Int?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  id          Int      @id @default(autoincrement())
  projectId   Int
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Server {
  name      String
  type      String?
  ip        String?
  domain    String?
  provider  String?
  status    ServerStatus @default(active)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  id        Int          @id @default(autoincrement())
  projectId Int
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Setting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GitHubSyncLog {
  id            Int       @id @default(autoincrement())
  repository    String
  status        String
  commitsFound  Int       @default(0)
  commitsLinked Int       @default(0)
  errorMessage  String?
  startedAt     DateTime  @default(now())
  finishedAt    DateTime?
}

model CalendarEvent {
  id          Int      @id @default(autoincrement())
  userId      Int
  title       String
  description String?
  date        DateTime @db.Date
  isAllDay    Boolean  @default(false)
  startTime   String?
  endTime     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WorkLog {
  id         Int         @id @default(autoincrement())
  taskId     Int
  userId     Int
  summary    String
  hours      Int
  minutes    Int         @default(0)
  type       WorkLogType @default(desarrollo)
  dateWorked DateTime    @default(now())
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  task       Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id])
}

model ArcaConfig {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique
  cuit            String
  razonSocial     String
  domicilioFiscal String?
  puntoVenta      Int       @default(1)
  condicionIva    String    @default("monotributo")
  iibb            String?
  inicioActividad DateTime?
  certificado     String?
  clavePrivada    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ArcaInvoice {
  id                Int               @id @default(autoincrement())
  userId            Int
  projectId         Int?
  paymentId         Int?
  tipoComprobante   ArcaInvoiceType   @default(factura_c)
  puntoVenta        Int
  numero            Int?
  receptorNombre    String
  receptorCuit      String?
  receptorDomicilio String?
  importeNeto       Decimal           @db.Decimal(12, 2)
  importeTotal      Decimal           @db.Decimal(12, 2)
  moneda            String            @default("PES")
  concepto          String
  conceptoTipo      Int               @default(2)
  periodoDesde      DateTime?
  periodoHasta      DateTime?
  vencimientoPago   DateTime?
  cae               String?
  caeVencimiento    DateTime?
  status            ArcaInvoiceStatus @default(draft)
  pdfUrl            String?
  pdfFilename       String?
  afipResponse      String?
  errorMessage      String?
  fechaEmision      DateTime          @default(now())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  User              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  project           Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  payment           Payment?          @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@index([cae])
  @@index([userId, fechaEmision])
  @@index([projectId])
  @@index([paymentId])
}

enum LeadStatus {
  new
  contacted
  qualified
  converted
  lost
}

enum ProjectStatus {
  active
  paused
  completed
  cancelled
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed
}

enum TaskStatus {
  cancelled
  completed
  in_progress
  pending
  draft
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum PaymentStatus {
  pending
  processed
  completed
  failed
}

enum InvoiceStatus {
  payed
  unpaid
  overdue
  canceled
}

enum ServerStatus {
  active
  inactive
  maintenance
}

enum WorkLogType {
  desarrollo
  gestion
  testing
  documentacion
  reunion
  otro
}

enum ArcaInvoiceStatus {
  draft
  pending
  authorized
  rejected
  cancelled
}

enum ArcaInvoiceType {
  factura_c
  nota_credito_c
  nota_debito_c
}

// --- WHATSAPP AUTO RESPONSES ---

// Contexto general de cómo respondemos
model WhatsAppContext {
  id          Int      @id @default(autoincrement())
  content     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Tipos de respuestas rápidas/templates
model WhatsAppResponseType {
  id          Int      @id @default(autoincrement())
  name        String
  example     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Contactos vinculados a números de WhatsApp
model WhatsAppContact {
  id          Int      @id @default(autoincrement())
  jid         String   @unique
  name        String
  company     String?
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
