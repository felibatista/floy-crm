generator client {
  provider = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

// --- ADMIN / STAFF USERS ---

model User {
  id            Int      @id @default(autoincrement())
  name          String
  email         String   @unique
  passwordHash  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  groups          Group[]
  assignedTasks   Task[]
  calendarEvents  CalendarEvent[]
  workLogs        WorkLog[]
}

model Group {
  id          Int      @id @default(autoincrement())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  permissions GroupPermission[]
}

model Permission {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  groupPermissions GroupPermission[]
}

model GroupPermission {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  groupId      Int
  permissionId Int

  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([groupId, permissionId])
}

// --- CRM CORE ---

enum LeadStatus {
  new
  contacted
  qualified
  converted
  lost
}

model Lead {
  id              Int      @id @default(autoincrement())
  name            String
  email           String?
  phone           String?
  company         String?
  status          LeadStatus   @default(new)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Client {
  id              Int      @id @default(autoincrement())
  name            String
  email           String?  @unique
  phone           String?
  company         String?
  address         String?
  
  // Portal Configuration
  slug            String   @unique // Subdomain: defender, acme
  isPortalEnabled Boolean  @default(false)
  passwordHash    String?  // Master password for the portal
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  projects        Project[]
  tickets         Ticket[]

  @@map("cliente")
}

enum ProjectStatus {
  active
  paused
  completed
  cancelled
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  clientId    Int
  status      ProjectStatus   @default(active)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // GitHub Integration
  githubRepo  String?   // formato: owner/repo (ej: "anthropics/claude-code")

  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks       Task[]
  payments    Payment[]
  files       File[]
  servers     Server[]
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed
}

model Ticket {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  clientId    Int
  priority    TicketPriority    @default(medium)
  status      TicketStatus      @default(open)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client      Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks       Task[]
}

enum TaskStatus {
  draft
  cancelled
  completed
  in_progress
  pending
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

model Task {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  title       String
  description String?
  projectId   Int
  ticketId    Int?
  assignedToId Int?
  category    String?
  status      TaskStatus @default(pending)
  priority    TaskPriority @default(medium)
  startDate   DateTime?
  endDate     DateTime?
  timeEstimated String?
  timeSpent     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  includeInChangeLog Boolean  @default(false)

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ticket      Ticket?  @relation(fields: [ticketId], references: [id])
  assignedTo  User?    @relation(fields: [assignedToId], references: [id])
  commits     Commit[]
  workLogs    WorkLog[]
}

model Commit {
  id          Int      @id @default(autoincrement())
  taskId      Int
  message     String
  author      String
  hash        String   @unique  // SHA del commit
  repository  String   // owner/repo
  url         String?  // URL al commit en GitHub
  committedAt DateTime // Fecha del commit en GitHub
  createdAt   DateTime @default(now())

  task        Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

enum PaymentStatus {
  pending
  processed
  completed
  failed
}

model Payment {
  id            Int      @id @default(autoincrement())
  projectId     Int
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("ARS")
  concept       String?
  paymentMethod String?
  status        PaymentStatus @default(pending)
  fechaPago     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invoices      Invoice[]
}

enum InvoiceStatus {
  payed
  unpaid
  overdue
  canceled
}

model Invoice {
  id             Int      @id @default(autoincrement())
  paymentId      Int
  invoiceNumber  String   @unique
  amount         Decimal  @db.Decimal(10, 2)
  currency       String   @default("ARS")
  emitted        DateTime @default(now())
  expiresAt      DateTime?
  status         InvoiceStatus @default(unpaid)
  link           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  payment        Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
}

model File {
  id          Int      @id @default(autoincrement())
  projectId   Int
  name        String
  url         String
  type        String?
  size        Int?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum ServerStatus {
  active
  inactive
  maintenance
}

model Server {
  id          Int      @id @default(autoincrement())
  projectId   Int
  name        String
  type        String?
  ip          String?
  domain      String?
  provider    String?
  status      ServerStatus @default(active)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Setting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- GITHUB INTEGRATION ---

model GitHubSyncLog {
  id            Int      @id @default(autoincrement())
  repository    String   // owner/repo
  status        String   // success, error
  commitsFound  Int      @default(0)
  commitsLinked Int      @default(0)
  errorMessage  String?
  startedAt     DateTime @default(now())
  finishedAt    DateTime?
}

model CalendarEvent {
  id          Int      @id @default(autoincrement())
  userId      Int
  title       String
  description String?
  date        DateTime @db.Date
  isAllDay    Boolean  @default(false)
  startTime   String?  // HH:mm format
  endTime     String?  // HH:mm format
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- WORK LOGS (Registro de trabajo en tareas) ---

enum WorkLogType {
  desarrollo
  gestion
  testing
  documentacion
  reunion
  otro
}

model WorkLog {
  id          Int         @id @default(autoincrement())
  taskId      Int
  userId      Int
  summary     String      // Resumen del trabajo realizado
  hours       Int         // Horas trabajadas (ej: 2)
  minutes     Int         @default(0) // Minutos trabajados (ej: 30)
  type        WorkLogType @default(desarrollo)
  dateWorked  DateTime    @default(now()) // Fecha del trabajo
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id])
}
